pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--variables
g = 1
p = {
	x=10,
	y=10,
	dx=0,
	dy=0,
	max_dx=0.5,
	w=8,
	h=8,
	sp=1,
	flp=false,
	spd=3,
	moving=false,
}

e = {
	id=0,
	x=0,
	y=0,
	dx=0,
	dy=0,
	max_dx=0.5,
	w=8,
	h=8,
	sp=4,
	flp=false,
	spd=3,
	moving=false,
	dst=10,
}

enemies = {}

pos = {
	{x=20, y=10,len=50,clr=4},
	{x=50, y=40,len=70,clr=5},
	{x=40, y=40,len=30,clr=4},
	{x=70, y=40,len=5,clr=5},
}
-->8
--game core
function _init()
	create_enemies()
end

function _update()
	player_update()
	enemies_update()
end

function _draw()
	cls()
	map(0, 0, 0, 0, 128, 32)
	draw_enemies()
	draw_player()
	local str = "dst: " ..
	tostr(enemies[1].dst)
	print(str,0,100)
end
-->8
-- player movement
function player_update()
	p.dy+=g
	if btn(➡️) then
		p.moving=true
		p.dx += p.spd
		p.flp = false
	end
	if btn(⬅️) then
		p.moving=true
		p.dx -= p.spd
		p.flp = true
	end
	if collide_map(p,"down",0) then
		p.dy=0
		p.y-=((p.y+p.h+1)%8)-1
	end
	if p.dx<0 then
 	p.dx=limit_speed(p.dx,p.max_dx)
 elseif p.dx>0 then
	 p.dx=limit_speed(p.dx,p.max_dx)
 end
 if p.moving
 	and not btn(⬅️)
 	and not btn(➡️) then
 	p.moving = false
 	p.dx=0
 end
	p.x+=p.dx
	p.y+=p.dy
end

function draw_player()
	spr(p.sp,p.x,p.y,1,1,p.flp)
end

function collide_map(obj, aim, flag)
	local x=obj.x		local y=obj.y
	local w=obj.w		local h=obj.h
	local x1=0	local x2=0
	local y1=0 local y2=0
	
	if aim=="left" then
		x1=x-1			y1=y
		x2=x					y2=y+h-1
	elseif aim=="right" then
		x1=x+w			y1=y
		x2=x+w+1	y2=y+h-1
	elseif aim=="up" then
		x1=x+1			y1=y-1
		x2=x+w+1	y2=y
	elseif aim=="down" then
		x1=x					y1=y+h
		x2=x+w			y2=y+h
	end
	x1/=8		x2/=8
	y1/=8		y2/=8
	
	if fget(mget(x1,y1), flag)
	or fget(mget(x1,y2), flag)
	or fget(mget(x2,y1), flag)
	or fget(mget(x2,y2), flag) then
		return true
	else
		return false
	end
end

function limit_speed(num,maximum)
  return mid(-maximum,num,maximum)
end
-->8
-- enemy movement
function enemies_update()
	for i = 1, #enemies do
		local e = enemies[i]
		local dx = 0
		if e.dst >= e.len then
			e.toggle = not e.toggle
			e.dst = 0			
		end
		e.dst+= 1
		if e.toggle then
			dx = 0.5
			e.flp= false
		else
			dx = -0.5
			e.flp= true
		end
		e.dy = g
		e.dx = dx
		
		if collide_map(e,"down",0) then
			e.dy=0
			e.y-=((e.y+e.h+1)%8)-1
		end
		e.x+=e.dx
		e.y+=e.dy
	end
end

function create_enemies()
	for i = 1, #pos do
		local e = pos[i]
		local enemy = create_enemy(
			i,
			e.x,
			e.y,
			e.len,
			e.clr
			)
		add(enemies, enemy)
	end
end

function create_enemy(id,x,y,len,clr)
	return {
	 id=id,
		x=x,
		y=y,
		dx=0,
		dy=0,
		w=8,
		h=8,
		dst=0,
		flp=false,
		len=len,
		toggle=true,
		clr=clr
	}
end

function draw_enemies()
	for i = 1, #enemies do
		draw_enemy(enemies[i])		
	end
end

function draw_enemy(obj)
	spr(obj.clr,obj.x,obj.y,1,1,obj.flp)
end
__gfx__
000c0000000500000c00000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ccc00000555000c0c0000050500000000000000000000000000cc0000005500000000000000000000000000000000000000000000000000000000000000000
00ccc000005550000cc00c00055005000ccc0202055502020000cccc000055550000000000000000000000000000000000000000000000000000000000000000
0ccccc0005555500ccc0ccc055505550ccdcc404556554041cc00ccc155005550000000000000000000000000000000000000000000000000000000000000000
00fff30000fff30000cccccc00555555dccdc44465565444cc1ccccc551555550000000000000000000000000000000000000000000000000000000000000000
00ffff0000ffff00000cccc000055550cddcc44056655440cccccccc555555550000000000000000000000000000000000000000000000000000000000000000
0cccccf0055555f0000c00c0000500500ccc442005554420000cccc0000555500000000000000000000000000000000000000000000000000000000000000000
0cccc0000555500000cc0cc000550550222222202222222000c0c0c0005050500000000000000000000000000000000000000000000000000000000000000000
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddd7dddddddd7dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0202000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1011101110111011101110111011101100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
